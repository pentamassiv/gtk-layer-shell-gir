name: 'Build, test, commit'
description: 'Builds the code, runs the tests and commits the changes'
inputs:
  commit_message:
    description: 'The commit message that will be used'
    required: false
    type: string

runs:
  using: "composite"
  steps:
    - name: Install gir
      working-directory: ./gir
      run: |
          ls
          export PATH=$PATH:/github/home/.cargo/bin
          cargo install --force --path .
    - name: Build and test the sys crate
      working-directory: ./gtk-layer-shell-sys
      run: |
          ls
          export PATH=$PATH:/github/home/.cargo/bin
          gir -o .
          cargo build --verbose
          cargo test --verbose
    - name: Build and test the wrapper crate
      working-directory: ./gtk-layer-shell/
      run: |
          ls
          export PATH=$PATH:/github/home/.cargo/bin
          gir -o .
          gir -c Gir.toml -d ../gir-files --doc-target-path docs.md -m doc
          cargo install rustdoc-stripper --force
          rustdoc-stripper -s -n
          rustdoc-stripper -g -o docs.md
          cargo build --verbose
          cargo test --verbose
          cargo doc
    - name: Build the example
      working-directory: ./gtk-layer-shell/
      run: cargo build --example simple-example
    - name: Build on aarch64
      uses: ./.github/workflows/build_aarch64.yml
    - name: Count the number of files other than the versions.txt files, which were changed
      id: changed_files
      if: ${{ inputs.commit_message != '' }}
      run: echo ::set-output name=NO_CHANGED_FILES::$(git diff --name-only -- . ':(exclude)gtk-layer-shell/src/auto/versions.txt' ':(exclude)gtk-layer-shell-sys/src/auto/versions.txt' | wc -l)
    - name: Create Pull Request when code was committed to main
      if: ${{ inputs.commit_message != '' }} & steps.changed_files.outputs.NO_CHANGED_FILES != '0'
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: ${{ inputs.commit_message }}
